# نظام الصيانة المحسن - دليل الاستخدام

## المميزات الجديدة المضافة:

### 1. البيانات الوهمية لعملاء مكة
- تم إنشاء Seeder شامل للبيانات الوهمية
- يحتوي على 30 عميل في مناطق مختلفة من مكة
- 6 فنيين مع توزيع على المناطق
- 10 خدمات مختلفة
- 50 طلب مع بيانات واقعية

**لتشغيل Seeder:**
```bash
php artisan db:seed --class=Database\\Seeds\\MakkahDummyDataSeeder
```

### 2. نظام رفع صور العطل
- الفني يمكنه رفع صور متعددة للعطل
- الصور تُحفظ في `assets/uploads/order-issues/`
- يمكن حذف الصور
- الصور مرتبطة بالطلب

**الاستخدام:**
- في صفحة تفاصيل الطلب للفني، يوجد قسم لرفع الصور
- يمكن رفع عدة صور في نفس الوقت
- الصور تظهر في صفحة الطلب للدعم الفني والأدمن

### 3. نظام الفواتير الإلكترونية
- إنشاء فواتير PDF للطلبات المكتملة
- رقم فاتورة تلقائي: `INV-YYYY-XXXXXX`
- الفاتورة تحتوي على:
  - معلومات العميل
  - معلومات الفني
  - تفاصيل الخدمة
  - السعر الإجمالي (يشمل الضريبة)
  - تاريخ الإصدار

**الاستخدام:**
- الأدمن/الدعم الفني: يمكنهم إنشاء فاتورة من صفحة الطلب
- الفني: يمكنه إنشاء فاتورة بعد إكمال الطلب
- يمكن عرض الفاتورة أو تحميلها كـ PDF

**Routes:**
- `GET /support/orders/{id}/invoice` - إنشاء/تحميل الفاتورة
- `GET /support/orders/{id}/invoice/view` - عرض الفاتورة
- `GET /technician/orders/{id}/invoice` - إنشاء/تحميل الفاتورة (للفني)

### 4. نظام شهادات الضمان الإلكترونية
- إنشاء شهادات ضمان PDF للطلبات المكتملة
- كود ضمان تلقائي: `WAR-XXXXXXXX`
- الشهادة تحتوي على:
  - معلومات العميل
  - معلومات الفني
  - تفاصيل الخدمة
  - مدة الضمان (افتراضي 30 يوم)
  - تاريخ الإصدار

**الاستخدام:**
- الأدمن/الدعم الفني: يمكنهم إنشاء شهادة ضمان من صفحة الطلب
- الفني: يمكنه إنشاء شهادة ضمان بعد إكمال الطلب
- يمكن عرض الشهادة أو تحميلها كـ PDF

**Routes:**
- `GET /support/orders/{id}/warranty` - إنشاء/تحميل شهادة الضمان
- `GET /support/orders/{id}/warranty/view` - عرض شهادة الضمان
- `GET /technician/orders/{id}/warranty` - إنشاء/تحميل شهادة الضمان (للفني)

### 5. نظام تعيين الفنيين المحسن
- تعيين يدوي: الأدمن/الدعم الفني يختار الفني
- تعيين تلقائي: النظام يختار الفني حسب:
  - المنطقة
  - التخصص
  - عدد الطلبات المكتملة
  - التقييم
- تحديث فوري: عند تعيين فني، يتم تحديث الطلب فوراً
- إشعارات: (قيد التطوير) إرسال إشعار للفني عند التعيين

### 6. الحقول الجديدة في جدول Orders

#### حقول الفاتورة:
- `invoice_pdf` - مسار ملف PDF الفاتورة
- `invoice_number` - رقم الفاتورة
- `invoice_date` - تاريخ إصدار الفاتورة
- `invoice_issued_by` - ID من أصدر الفاتورة

#### حقول شهادة الضمان:
- `warranty_pdf` - مسار ملف PDF شهادة الضمان
- `warranty_issued_at` - تاريخ إصدار شهادة الضمان
- `warranty_issued_by` - ID من أصدر شهادة الضمان

#### حقول صور العطل:
- `issue_image` - صورة واحدة (للتوافق مع النظام القديم)
- `issue_images` - JSON array لصور متعددة

## خطوات التثبيت:

### 1. تشغيل Migrations:
```bash
php artisan migrate
```

### 2. تشغيل Seeder للبيانات الوهمية:
```bash
php artisan db:seed --class=Database\\Seeds\\MakkahDummyDataSeeder
```

### 3. التأكد من تثبيت مكتبة PDF:
```bash
composer require barryvdh/laravel-dompdf
```

### 4. إضافة Provider في config/app.php:
```php
Barryvdh\DomPDF\ServiceProvider::class,
```

### 5. نشر ملفات Config:
```bash
php artisan vendor:publish --provider="Barryvdh\DomPDF\ServiceProvider"
```

## ملاحظات مهمة:

1. **الصلاحيات**: تأكد من أن الأدوار (Roles) موجودة:
   - Admin
   - Support
   - Technician
   - Client

2. **المجلدات**: تأكد من وجود المجلدات التالية مع صلاحيات الكتابة:
   - `assets/uploads/order-issues/`
   - `assets/uploads/invoices/`
   - `assets/uploads/warranties/`

3. **المناطق**: تأكد من تشغيل Seeder المناطق أولاً:
   ```bash
   php artisan db:seed --class=Database\\Seeds\\UpdateMakkahRegionsSeeder
   ```

## الملفات المضافة/المعدلة:

### Migrations:
- `2025_01_15_000001_add_invoice_warranty_fields_to_orders_table.php`

### Models:
- `Order.php` - تم تحديثه بإضافة الحقول والعلاقات الجديدة

### Controllers:
- `InvoiceController.php` - جديد
- `WarrantyController.php` - جديد
- `TechnicianController.php` - تم تحديثه بإضافة وظائف رفع الصور
- `SupportController.php` - موجود بالفعل (تعيين الفنيين)

### Routes:
- `technician.php` - تم تحديثه
- `support.php` - تم تحديثه

### Seeders:
- `MakkahDummyDataSeeder.php` - جديد

## الخطوات التالية (قيد التطوير):

1. إنشاء Views للفواتير والشهادات
2. إضافة إشعارات عند تعيين الفني
3. إضافة تقارير إحصائية
4. إضافة نظام تقييم للفنيين
5. إضافة نظام متابعة حالة الطلب في الوقت الفعلي

