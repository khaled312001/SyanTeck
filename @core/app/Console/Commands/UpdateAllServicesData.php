<?php

namespace App\Console\Commands;

use Illuminate\Console\Command;
use App\Service;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;

class UpdateAllServicesData extends Command
{
    /**
     * The name and signature of the console command.
     *
     * @var string
     */
    protected $signature = 'services:update-all-data {--price=100} {--online-price=150} {--delivery-days=3} {--revision=2} {--force : تحديث جميع الأوصاف حتى لو كانت أكثر من 150 حرف}';

    /**
     * The console command description.
     *
     * @var string
     */
    protected $description = 'تحديث جميع الخدمات بالبيانات الناقصة (السعر، نوع الخدمة، أيام التسليم، المراجعات)';

    /**
     * Execute the console command.
     *
     * @return int
     */
    public function handle()
    {
        $this->info('جاري تحديث جميع الخدمات بالبيانات الوهمية الكاملة...');
        $this->newLine();

        // قائمة الأوصاف الوهمية (كل وصف أكثر من 150 حرف)
        $fakeDescriptions = [
            '<p>نوفر خدمات صيانة وإصلاح شاملة ومتكاملة لجميع احتياجاتك اليومية. فريقنا من الفنيين المعتمدين والمحترفين جاهز لتقديم أفضل الخدمات بأعلى معايير الجودة والسلامة. نحن نضمن لك خدمة سريعة وفعالة مع ضمان شامل على جميع الأعمال المنجزة. خبرتنا الواسعة في المجال تمكننا من التعامل مع جميع أنواع الأعطال والمشاكل بسرعة وكفاءة عالية.</p><p><br></p><p>تشمل خدماتنا:</p><ul><li>فحص شامل وتشخيص دقيق للمشكلة</li><li>إصلاح وصيانة احترافية بجودة عالية</li><li>استبدال القطع التالفة بقطع أصلية وموثوقة</li><li>ضمان شامل على جميع الأعمال المنجزة</li><li>خدمة عملاء على مدار الساعة طوال أيام الأسبوع</li><li>أسعار شفافة ومنافسة في السوق</li><li>استخدام أحدث المعدات والتقنيات الحديثة</li><li>فريق محترف ومدرب على أعلى المستويات</li></ul>',
            '<p>خدمات احترافية متخصصة في مجال الصيانة والإصلاح بجميع أنواعها. نقدم حلولاً شاملة ومبتكرة لجميع مشاكلك مع فريق من الخبراء المعتمدين والمدربين. نحن نلتزم بأعلى معايير الجودة والكفاءة في تنفيذ جميع الأعمال. خبرتنا الطويلة في السوق تجعلنا الخيار الأمثل لجميع احتياجاتك في مجال الصيانة والإصلاح.</p><p><br></p><p>مميزات خدماتنا:</p><ul><li>سرعة فائقة في الاستجابة والتنفيذ</li><li>جودة عالية جداً في الأداء والنتائج</li><li>أسعار مناسبة ومنافسة في السوق المحلي</li><li>ضمان شامل ومضمون على جميع الأعمال</li><li>فريق محترف ومدرب على أحدث التقنيات</li><li>خدمة عملاء ممتازة ومتابعة مستمرة</li><li>استخدام قطع غيار أصلية وموثوقة</li><li>التزام بالمواعيد المحددة مسبقاً</li></ul>',
            '<p>نقدم خدمات صيانة وإصلاح متكاملة وشاملة لجميع احتياجاتك اليومية والمستقبلية. فريقنا المختص والمحترف يضمن لك الحصول على أفضل النتائج بأسرع وقت ممكن وبأعلى جودة. نحن نستخدم أحدث التقنيات والأدوات المتطورة لضمان جودة عالية في جميع أعمالنا. خبرتنا الواسعة في المجال تجعلنا قادرين على حل أي مشكلة مهما كانت معقدة.</p><p><br></p><p>لماذا تختارنا:</p><ul><li>خبرة واسعة تمتد لسنوات عديدة في المجال</li><li>فريق محترف ومدرب على أعلى المستويات</li><li>أحدث المعدات والتقنيات الحديثة والمتطورة</li><li>أسعار شفافة وعادلة ومناسبة لجميع الفئات</li><li>ضمان شامل ومضمون على جميع الأعمال المنجزة</li><li>خدمة سريعة وفعالة في جميع الأوقات</li><li>متابعة مستمرة بعد إتمام العمل</li><li>التزام تام بالمواعيد والجودة</li></ul>',
            '<p>خدمات صيانة وإصلاح احترافية مع ضمان الجودة والكفاءة في جميع أعمالنا. نحن نقدم حلولاً شاملة ومتكاملة لجميع مشاكلك مع فريق من الخبراء المعتمدين والمدربين. نضمن لك خدمة ممتازة وأسعار مناسبة مع ضمان شامل على جميع الأعمال المنجزة. خبرتنا الطويلة في السوق تجعلنا الخيار الأول للعديد من العملاء.</p><p><br></p><p>خدماتنا تشمل:</p><ul><li>تشخيص دقيق وشامل للمشكلة من جميع الجوانب</li><li>إصلاح وصيانة احترافية بجودة عالية ومضمونة</li><li>استبدال القطع التالفة بقطع أصلية وموثوقة</li><li>فحص شامل ومفصل بعد الإصلاح للتأكد من الجودة</li><li>نصائح وإرشادات قيمة للصيانة الدورية</li><li>خدمة متابعة مستمرة بعد الإصلاح</li><li>استخدام أحدث الأدوات والمعدات المتطورة</li><li>فريق محترف متاح على مدار الساعة</li></ul>',
            '<p>نوفر خدمات صيانة وإصلاح متخصصة وشاملة لجميع احتياجاتك في مختلف المجالات. فريقنا المحترف والمعتمد يضمن لك الحصول على أفضل الخدمات بأعلى معايير الجودة والكفاءة. نحن نستخدم أحدث التقنيات والأدوات المتطورة لضمان نتائج ممتازة في جميع أعمالنا. خبرتنا الواسعة في السوق تجعلنا قادرين على التعامل مع جميع أنواع المشاكل بسرعة وكفاءة.</p><p><br></p><p>مميزاتنا:</p><ul><li>سرعة فائقة في التنفيذ والإنجاز</li><li>جودة عالية جداً في الأداء والنتائج</li><li>أسعار مناسبة ومنافسة في السوق</li><li>ضمان شامل ومضمون على جميع الأعمال</li><li>فريق محترف ومدرب على أحدث التقنيات</li><li>خدمة عملاء ممتازة ومتابعة مستمرة</li><li>استخدام قطع غيار أصلية وموثوقة</li><li>التزام تام بالمواعيد والجودة المطلوبة</li></ul>',
            '<p>نقدم خدمات صيانة وإصلاح متكاملة بأسعار مناسبة وجودة عالية. فريقنا من الفنيين المحترفين والمعتمدين جاهز لتقديم أفضل الخدمات في جميع الأوقات. نحن نضمن لك خدمة سريعة وفعالة مع ضمان شامل على جميع الأعمال المنجزة. خبرتنا الواسعة في المجال تمكننا من التعامل مع جميع أنواع الأعطال والمشاكل بسرعة وكفاءة عالية.</p><p><br></p><p>ما يميزنا:</p><ul><li>خدمة سريعة وفعالة في جميع الأوقات</li><li>جودة عالية ومضمونة في جميع الأعمال</li><li>أسعار مناسبة ومنافسة في السوق</li><li>ضمان شامل على جميع الأعمال المنجزة</li><li>فريق محترف ومدرب على أعلى المستويات</li><li>استخدام أحدث المعدات والتقنيات</li><li>قطع غيار أصلية وموثوقة</li><li>متابعة مستمرة بعد إتمام العمل</li></ul>',
            '<p>خدمات صيانة وإصلاح شاملة ومتكاملة لجميع احتياجاتك. فريقنا من الخبراء المعتمدين والمدربين يضمن لك الحصول على أفضل النتائج بأسرع وقت ممكن. نحن نستخدم أحدث التقنيات والأدوات المتطورة لضمان جودة عالية في جميع أعمالنا. خبرتنا الطويلة في السوق تجعلنا الخيار الأمثل لجميع احتياجاتك في مجال الصيانة والإصلاح.</p><p><br></p><p>خدماتنا المميزة:</p><ul><li>فحص شامل وتشخيص دقيق للمشكلة</li><li>إصلاح وصيانة احترافية بجودة عالية</li><li>استبدال القطع التالفة بقطع أصلية</li><li>ضمان شامل على جميع الأعمال</li><li>خدمة عملاء على مدار الساعة</li><li>أسعار شفافة ومنافسة</li><li>استخدام أحدث المعدات والتقنيات</li><li>فريق محترف ومدرب</li></ul>',
            '<p>نوفر خدمات صيانة وإصلاح متخصصة بجودة عالية وأسعار مناسبة. فريقنا المحترف والمعتمد يضمن لك الحصول على أفضل الخدمات بأعلى معايير الجودة والكفاءة. نحن نستخدم أحدث التقنيات والأدوات المتطورة لضمان نتائج ممتازة في جميع أعمالنا. خبرتنا الواسعة في السوق تجعلنا قادرين على التعامل مع جميع أنواع المشاكل بسرعة وكفاءة.</p><p><br></p><p>لماذا نحن الأفضل:</p><ul><li>خبرة واسعة تمتد لسنوات عديدة</li><li>فريق محترف ومدرب على أعلى المستويات</li><li>أحدث المعدات والتقنيات الحديثة</li><li>أسعار شفافة وعادلة ومناسبة</li><li>ضمان شامل ومضمون على جميع الأعمال</li><li>خدمة سريعة وفعالة في جميع الأوقات</li><li>متابعة مستمرة بعد إتمام العمل</li><li>التزام تام بالمواعيد والجودة</li></ul>',
            '<p>خدمات صيانة وإصلاح احترافية مع ضمان الجودة والكفاءة. نحن نقدم حلولاً شاملة ومتكاملة لجميع مشاكلك مع فريق من الخبراء المعتمدين والمدربين. نضمن لك خدمة ممتازة وأسعار مناسبة مع ضمان شامل على جميع الأعمال المنجزة. خبرتنا الطويلة في السوق تجعلنا الخيار الأول للعديد من العملاء الراضين عن خدماتنا.</p><p><br></p><p>خدماتنا تشمل:</p><ul><li>تشخيص دقيق وشامل للمشكلة</li><li>إصلاح وصيانة احترافية بجودة عالية</li><li>استبدال القطع التالفة بقطع أصلية</li><li>فحص شامل بعد الإصلاح</li><li>نصائح وإرشادات للصيانة الدورية</li><li>خدمة متابعة مستمرة</li><li>استخدام أحدث الأدوات والمعدات</li><li>فريق محترف متاح على مدار الساعة</li></ul>',
            '<p>نقدم خدمات صيانة وإصلاح متكاملة وشاملة لجميع احتياجاتك. فريقنا المختص والمحترف يضمن لك الحصول على أفضل النتائج بأسرع وقت ممكن وبأعلى جودة. نحن نستخدم أحدث التقنيات والأدوات المتطورة لضمان جودة عالية في جميع أعمالنا. خبرتنا الواسعة في المجال تجعلنا قادرين على حل أي مشكلة مهما كانت معقدة أو صعبة.</p><p><br></p><p>مميزات خدماتنا:</p><ul><li>سرعة فائقة في الاستجابة والتنفيذ</li><li>جودة عالية جداً في الأداء والنتائج</li><li>أسعار مناسبة ومنافسة في السوق</li><li>ضمان شامل ومضمون على جميع الأعمال</li><li>فريق محترف ومدرب على أحدث التقنيات</li><li>خدمة عملاء ممتازة ومتابعة مستمرة</li><li>استخدام قطع غيار أصلية وموثوقة</li><li>التزام بالمواعيد المحددة مسبقاً</li></ul>',
        ];

        // قائمة الأسعار الوهمية
        $fakePrices = [100, 150, 200, 250, 300, 350, 400, 450, 500];
        $fakeOnlinePrices = [150, 200, 250, 300, 350, 400, 450, 500, 550];
        $fakeDeliveryDays = [1, 2, 3, 4, 5, 7];
        $fakeRevisions = [1, 2, 3, 4];

        // الحصول على جميع الخدمات
        $services = Service::all();
        $totalServices = $services->count();

        if ($totalServices === 0) {
            $this->warn('لا توجد خدمات لتحديثها.');
            return Command::SUCCESS;
        }

        $this->info("تم العثور على {$totalServices} خدمة.");
        $this->newLine();

        $updated = 0;
        $skipped = 0;
        $bar = $this->output->createProgressBar($totalServices);
        $bar->start();

        foreach ($services as $service) {
            $updateData = [];
            $needsUpdate = false;

            // تحديث الوصف إذا كان قصيراً (أقل من 150 حرف) أو فارغاً أو إذا كان force
            $forceUpdate = $this->option('force');
            $currentDescription = strip_tags($service->description ?? '');
            $currentDescriptionLength = mb_strlen($currentDescription, 'UTF-8');
            if ($forceUpdate || empty($currentDescription) || $currentDescriptionLength < 150) {
                $randomDescription = $fakeDescriptions[array_rand($fakeDescriptions)];
                $updateData['description'] = $randomDescription;
                $needsUpdate = true;
            }

            // تحديث السعر إذا كان null أو 0
            if (empty($service->price) || $service->price == 0) {
                $updateData['price'] = $fakePrices[array_rand($fakePrices)];
                $needsUpdate = true;
            }

            // تحديث نوع الخدمة إذا كان null
            if (is_null($service->is_service_online)) {
                $updateData['is_service_online'] = rand(0, 1); // عشوائي بين أونلاين وأوفلاين
                $needsUpdate = true;
            }

            // تحديث سعر الخدمة الأونلاين إذا كان null أو 0
            if (is_null($service->online_service_price) || $service->online_service_price == 0) {
                $updateData['online_service_price'] = $fakeOnlinePrices[array_rand($fakeOnlinePrices)];
                $needsUpdate = true;
            }

            // تحديث أيام التسليم إذا كان null أو 0
            if (is_null($service->delivery_days) || $service->delivery_days == 0) {
                $updateData['delivery_days'] = $fakeDeliveryDays[array_rand($fakeDeliveryDays)];
                $needsUpdate = true;
            }

            // تحديث عدد المراجعات إذا كان null أو 0
            if (is_null($service->revision) || $service->revision == 0) {
                $updateData['revision'] = $fakeRevisions[array_rand($fakeRevisions)];
                $needsUpdate = true;
            }

            // تحديث slug إذا كان فارغاً
            if (empty($service->slug)) {
                $updateData['slug'] = Str::slug($service->title);
                $needsUpdate = true;
            }

            // تحديث status إذا كان null
            if (is_null($service->status)) {
                $updateData['status'] = 1; // مفعّل
                $needsUpdate = true;
            }

            // تحديث is_service_on إذا كان null
            if (is_null($service->is_service_on)) {
                $updateData['is_service_on'] = 1; // مفعّل
                $needsUpdate = true;
            }

            // تحديث featured إذا كان null
            if (is_null($service->featured)) {
                $updateData['featured'] = rand(0, 1); // عشوائي
                $needsUpdate = true;
            }

            // تحديث view إذا كان null
            if (is_null($service->view)) {
                $updateData['view'] = rand(0, 1000); // عدد مشاهدات وهمي
                $needsUpdate = true;
            }

            if ($needsUpdate) {
                try {
                    Service::where('id', $service->id)->update($updateData);
                    $updated++;
                } catch (\Exception $e) {
                    $this->newLine();
                    $this->error("خطأ في تحديث الخدمة ID: {$service->id} - {$e->getMessage()}");
                    $skipped++;
                }
            } else {
                $skipped++;
            }

            $bar->advance();
        }

        $bar->finish();
        $this->newLine(2);

        $this->info("تم التحديث بنجاح!");
        $this->table(
            ['الإحصائيات', 'العدد'],
            [
                ['إجمالي الخدمات', $totalServices],
                ['تم تحديثها', $updated],
                ['تم تخطيها (لا تحتاج تحديث)', $skipped],
            ]
        );

        return Command::SUCCESS;
    }
}

